const D={enable:chrome.runtime.getURL("img/icon-32.png"),disable:chrome.runtime.getURL("img/icon-32-disabled.png")};async function m(){var e;const t=await chrome.tabs.query({active:!0,currentWindow:!0}),o=t==null?void 0:t[0];if(!o)return;if(!o.url||!o.url.match(/^https?:\/\//)){chrome.action.setIcon({path:D.disable,tabId:o.id});return}const n=(e=o.url.match(/^https?:\/\/([^\/]+)/))==null?void 0:e[1];if(!n){chrome.action.setIcon({path:D.disable,tabId:o.id});return}const i="disabled:"+n;if((await chrome.storage.sync.get([i]))[i]){chrome.action.setIcon({path:D.disable,tabId:o.id});return}chrome.action.setIcon({path:D.enable,tabId:o.id})}let u=null,f=null,I=!1;function g(t){if(I)return;I=!0;const o=new Promise((i,r)=>{const e=indexedDB.open("db",4);e.onupgradeneeded=function(){if(!e.result.objectStoreNames.contains("detections")){let c=e.result.createObjectStore("detections",{keyPath:"key"});c.createIndex("tabId",["tab.id","updatedAt"],{unique:!1}),c.createIndex("host",["host","updatedAt"],{unique:!1}),c.createIndex("updatedAt","updatedAt",{unique:!1})}},e.onsuccess=function(){u=e.result,i(null)}}),n=new Promise((i,r)=>{const e=indexedDB.open("stats",2);e.onupgradeneeded=function(){e.result.objectStoreNames.contains("stats")||e.result.createObjectStore("stats",{keyPath:"host"}).createIndex("updatedAt","updatedAt",{unique:!1})},e.onsuccess=function(){f=e.result,i(null)}});Promise.all([o,n]).then(()=>{I=!1,A(),setInterval(A,1e3*60*60*1),t&&t()})}function A(){if(!u)return;const t=u.transaction("detections","readwrite"),o=t.objectStore("detections").index("updatedAt").openCursor(null,"next");o.onsuccess=function(n){const i=o.result;i&&i.value.updatedAt<Date.now()-1e3*60*60*24*30?(i.delete(),i.continue()):t.commit()},o.onerror=function(n){t.abort()}}function S(t,o,n,i,r){if(!u||!f)return;const e=t+"@"+o,c=o==null?void 0:o.split("/")[2],s=u.transaction("detections","readwrite"),a=s.objectStore("detections"),h=a.get(e);h.onsuccess=function(y){let d=h.result;d?(d.detections.push(i),d.updatedAt=Date.now()):d={key:e,url:o,host:c,origins:n,tab:{id:r.id,favIconUrl:r.favIconUrl,title:r.title},detections:[i],updatedAt:Date.now()};const b=a.put(d);b.onsuccess=function(){s.commit()},b.onerror=function(B){s.abort()}},h.onerror=function(y){s.abort()};const l=f.transaction("stats","readwrite"),w=l.objectStore("stats"),p=w.get(c);p.onsuccess=function(y){let d=p.result;d?(d.count++,d.countByType[i.type]++,d.updatedAt=Date.now()):d={host:c,count:1,countByType:{CANVAS:i.type==="CANVAS"?1:0,WEBGL:i.type==="WEBGL"?1:0,FONT:i.type==="FONT"?1:0,AUDIO:i.type==="AUDIO"?1:0},updatedAt:Date.now()};const b=w.put(d);b.onsuccess=function(){l.commit()},b.onerror=function(B){l.abort()}},p.onerror=function(y){l.abort()}}function v(t,o,n,i,r){if(r.incognito){chrome.storage.session.get(["detections:"+r.id],function(e){const c=e["detections:"+r.id]||[];let s=!1;for(let a=0;a<c.length;a++)if(c[a].key===t+"@"+o){c[a].detections.push(i),c[a].updatedAt=Date.now(),s=!0;break}if(!s){const a={key:t+"@"+o,url:o,host:o==null?void 0:o.split("/")[2],origins:n,tab:{id:r.id,favIconUrl:r.favIconUrl,title:r.title},detections:[i],updatedAt:Date.now()};c.push(a)}chrome.storage.session.set({["detections:"+r.id]:c})});return}u?S(t,o,n,i,r):g(()=>{S(t,o,n,i,r)})}async function x(t,o=!1){return o?new Promise(n=>{chrome.storage.session.get(["detections:"+t],function(i){if(i){const r=i["detections:"+t]||[];n(r)}else n([])})}):new Promise(n=>{chrome.storage.session.get(["tab-started:"+t],function(i){const r=i["tab-started:"+t];if(!r){n([]);return}const e=function(){if(!u)return;const c=u.transaction("detections","readonly"),s=c.objectStore("detections").index("tabId").openCursor(IDBKeyRange.bound([t,r],[t,Date.now()]),"prev"),a=[];s.onsuccess=function(h){const l=s.result;l?(a.push(l.value),l.continue()):(c.abort(),n(a))},s.onerror=function(h){c.abort(),n([])}};u?e():g(()=>{e()})})})}async function j(t,o=Date.now()){return new Promise(n=>{const i=function(){if(!u)return;const r=u.transaction("detections","readonly"),e=r.objectStore("detections").index("host").openCursor(IDBKeyRange.bound([t,0],[t,o]),"prev"),c=[];e.onsuccess=function(s){const a=e.result;if(a){if(c.push(a.value),c.length>=5){r.abort(),n(c);return}a.continue()}else r.abort(),n(c)},e.onerror=function(s){r.abort(),n([])}};u?i():g(()=>{i()})})}async function k(t){if(!f||!u)return;const o=f.transaction("stats","readwrite"),i=o.objectStore("stats").delete(t);i.onsuccess=function(s){o.commit()},i.onerror=function(s){o.abort()};const r=u.transaction("detections","readwrite"),c=r.objectStore("detections").index("host").openCursor(t);c.onsuccess=function(s){const a=c.result;a?(a.delete(),a.continue()):r.commit()},c.onerror=function(s){r.abort()}}async function L(){return new Promise(t=>{f?o():g(()=>{o()});function o(){if(!f)return;const n=f.transaction("stats","readonly"),i=n.objectStore("stats").index("updatedAt").openCursor(null,"prev"),r=[];i.onsuccess=function(e){const c=i.result;c?(r.push(c.value),c.continue()):(n.abort(),t(r))},i.onerror=function(e){n.abort(),t([])}}})}chrome.runtime.onStartup.addListener(function(){g(),m(),chrome.storage.local.get(["reload"],function(t){t.reload&&chrome.storage.local.remove(["reload"]).then(()=>{chrome.tabs.query({active:!0,currentWindow:!0}).then(o=>{o.forEach(n=>{chrome.tabs.reload(n.id)})})})})});chrome.tabs.onActivated.addListener(function(){m()});const P=function(t,o,n){var i,r;if(!t||!t.action)return n({result:"no action"}),!0;if(t.action==="setDisabled"){const e="disabled:"+t.host;return t.disabled?(chrome.storage.sync.set({[e]:t.disabled},()=>{m().then(()=>{n({result:"ok"})}).catch(c=>{n({result:"error"})})}),!0):(chrome.storage.sync.remove(e,()=>{m().then(()=>{n({result:"ok"})}).catch(c=>{n({result:"error"})})}),!0)}if(t.action==="getDisabled"){const e="disabled:"+t.host;return chrome.storage.sync.get([e],function(c){n({disabled:c[e]})}),!0}if(t.action==="getWhiteList")return chrome.storage.sync.get(null,function(e){const c=[];Object.keys(e).sort().forEach(s=>{s.startsWith("disabled:")&&c.push(s.replace("disabled:",""))}),n({whiteList:c})}),!0;if(t.action==="scriptLoaded"){const e=(i=o.tab)==null?void 0:i.id;return e&&chrome.storage.session.get(["hosts:"+e],function(c){const s=c["hosts:"+e]||[];s.includes(t.host)||(s.push(t.host),chrome.storage.session.set({["hosts:"+e]:s}).then(()=>{}))}),!0}if(t.action==="getHosts"){const e=t.tabID;return e&&chrome.storage.session.get(["hosts:"+e],function(c){const s=c["hosts:"+e]||[];n({hosts:s})}),!0}return t.action==="resetDetection"?o.frameId?(n({result:"ok"}),!0):(o.tab&&o.tab.id&&(chrome.storage.session.remove(["hosts:"+o.tab.id]).then(()=>{}),chrome.storage.session.set({["tab-started:"+o.tab.id]:Date.now()}),o.tab.incognito&&chrome.storage.session.remove("detections:"+o.tab.id)),m().then(()=>{var e;chrome.action.setBadgeText({text:"",tabId:(e=o.tab)==null?void 0:e.id}),n({result:"ok"})}).catch(e=>{n({result:"error"})}),!0):t.action==="setDetected"?o.tab?(o.tab,chrome.action.setBadgeText({text:"!",tabId:o.tab.id}),chrome.action.setBadgeBackgroundColor({color:"#FF0000",tabId:(r=o.tab)==null?void 0:r.id}),v(o.documentId,t.src,t.origins,t.detection,o.tab),chrome.storage.sync.get("totalDetected",function(e){const c=e.totalDetected||0;chrome.storage.sync.set({totalDetected:c+1})}),n({result:"ok"}),!0):!1:t.action==="getTabDetection"?(x(t.tabId,t.isIncognito).then(e=>{n(e)}).catch(e=>{n([])}),!0):t.action==="getHostDetection"?(j(t.host,t.upBound).then(e=>{n(e)}).catch(e=>{n([])}),!0):t.action==="removeHostStats"?(k(t.host).finally(()=>{n()}),!0):t.action==="getHostStats"?(L().then(e=>{n(e)}).catch(e=>{n([])}),!0):!1};chrome.runtime.onMessage.hasListeners()||chrome.runtime.onMessage.addListener(P);
